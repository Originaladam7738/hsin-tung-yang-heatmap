# 新東陽熱力圖分析系統 - 使用說明

## 系統簡介

這是一個基於容留時間的人流熱力圖分析系統，能夠：
- 使用平面圖 PDF 作為底圖
- 連接 PostgreSQL 資料庫讀取人員進出記錄
- 計算每個區域的容留時間（人員停留時間）
- 生成視覺化熱力圖

## 快速開始

### 1. 啟動系統

```bash
npm start
```

伺服器會自動啟動在 `http://localhost:3000`，並自動連接到新東陽資料庫。

### 2. 開啟網頁

在瀏覽器中開啟：
```
http://localhost:3000/heatmap.html
```

### 3. 使用步驟

#### 步驟一：確認資料庫連接
- 頁面載入後，左側面板會顯示「✓ 已連接到新東陽資料庫」
- 系統會自動載入 PDF 平面圖作為底圖

#### 步驟二：選擇要分析的區域
- 在「選擇區域」區塊中，勾選您想要分析的區域
- 可以選擇多個區域
- 區域列表來自資料庫的 `v_area` 表

#### 步驟三：設定時間區間
- 選擇「開始時間」和「結束時間」
- 預設為 2025-10-08 全天
- 可根據需要調整

#### 步驟四：調整熱力圖強度
- 使用滑桿調整「強度係數」（1-100）
- 較高的值會產生更明顯的熱力效果

#### 步驟五：生成熱力圖
- 點擊「生成熱力圖」按鈕
- 系統會計算選定時間區間內，各區域的容留時間
- 熱力圖會疊加顯示在平面圖上

#### 步驟六：查看統計資訊
- 底部「統計資訊」區塊會顯示：
  - 總區域數
  - 總訪問次數
  - 總容留時間

## 系統架構

### 資料庫結構

系統使用兩個主要的資料表/視圖：

#### 1. v_store_analysis（容留記錄）
```sql
- id: 主鍵
- area_id: 區域 ID
- reid: 人員 ID
- enter_time: 進入時間
- exit_time: 離開時間
```

#### 2. v_area（區域資訊）
```sql
- area_id: 區域 ID
- area_name: 區域名稱
- area_number: 區域編號
```

### 容留時間計算

容留時間 = `exit_time - enter_time`

系統會計算：
- **總容留時間**：該時間區間內所有人在該區域的停留時間總和
- **平均容留時間**：總容留時間 ÷ 訪問次數
- **訪問次數**：該時間區間內進入該區域的總人次

### 熱力圖顏色說明

- **藍色/綠色**：容留時間較短的區域
- **黃色/橙色**：容留時間中等的區域
- **紅色**：容留時間最長的區域（熱點）

## API 端點

系統提供以下 API：

### 1. 連接資料庫
```
POST /api/connect
```

### 2. 取得區域列表
```
GET /api/areas
```

### 3. 取得熱力圖資料
```
POST /api/heatmap
Body: {
  "areaIds": [2767, 2769, ...],
  "startTime": "2025-10-08T00:00",
  "endTime": "2025-10-08T23:59"
}
```

### 4. 取得詳細統計
```
POST /api/statistics
Body: {
  "areaIds": [2767, 2769, ...],
  "startTime": "2025-10-08T00:00",
  "endTime": "2025-10-08T23:59"
}
```

## 檔案說明

### 核心檔案

- **heatmap.html** - 新版前端頁面（使用 PDF 底圖）
- **heatmap_app.js** - 新版前端邏輯（支援容留時間熱力圖）
- **server_pg.js** - PostgreSQL 後端服務
- **PL-01平面圖(規制用全區編號).pdf** - 平面圖底圖

### 舊版檔案（參考用）

- **index.html** - 舊版前端（使用圖片上傳）
- **app.js** - 舊版前端邏輯
- **server.js** - MySQL 後端服務

## 進階功能

### 自訂區域座標映射

目前系統使用簡單的雜湊演算法來估算區域在平面圖上的位置。如果您需要精確的區域定位，可以修改 `heatmap_app.js` 中的 `estimateAreaPosition()` 函數：

```javascript
function estimateAreaPosition(area) {
    // 建立區域 ID 到座標的映射
    const areaPositions = {
        2767: { x: 100, y: 200 },
        2769: { x: 300, y: 400 },
        // ... 添加更多區域
    };

    return areaPositions[area.areaId] || null;
}
```

### 調整資料庫連接

如需連接不同的資料庫，請修改 `server_pg.js` 中的 `defaultDbConfig`：

```javascript
const defaultDbConfig = {
    host: 'your-host',
    port: 5432,
    database: 'your-database',
    user: 'your-username',
    password: 'your-password',
    ssl: false
};
```

## 疑難排解

### 問題：資料庫連接失敗

**解決方案：**
1. 檢查資料庫伺服器是否運行
2. 確認網路連接正常
3. 檢查 `server_pg.js` 中的連接設定

### 問題：PDF 底圖無法顯示

**解決方案：**
1. 確認 PDF 檔案存在於專案根目錄
2. 檢查瀏覽器控制台是否有錯誤訊息
3. 確認 PDF.js 資源載入正常

### 問題：熱力圖沒有資料

**解決方案：**
1. 確認選擇的時間區間內有資料
2. 檢查選擇的區域是否正確
3. 查看瀏覽器控制台的錯誤訊息

### 問題：熱力圖位置不準確

**解決方案：**
- 這是因為目前使用估算的位置
- 需要建立區域 ID 到實際平面圖座標的映射表
- 請參考「自訂區域座標映射」章節

## 技術支援

如有任何問題，請檢查：
1. 瀏覽器控制台（F12）的錯誤訊息
2. 伺服器終端機的日誌輸出
3. 資料庫連接狀態

## 授權

MIT License
